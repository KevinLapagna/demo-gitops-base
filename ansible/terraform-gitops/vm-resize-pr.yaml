---
# VM Instance Type Change Workflow
# 
# This playbook changes the instance type of an existing VM by:
# 1. Cloning the Terraform repository
# 2. Locating the specified VM instance in instances.tf
# 3. Updating the instance_type parameter
# 4. Creating a pull request with the changes
# 
# Required variables:
# - instance_name_to_resize: Name of the VM instance to resize (must match existing instance)
# - new_instance_type: New instance type (e.g., t3.large, m5.xlarge, etc.)
# - req_id: Unique identifier for this request
# 
# Note: Changing instance type requires stopping and starting the VM, which will cause downtime.
# Some instance type changes may also require EBS optimization or other configuration changes.
#
- name: Clone Repo, Change VM Instance Type, Commit, Push, and Create PR - VM Resize
  hosts: localhost
  gather_facts: false
  vars_files:
    - shared-vars.yaml
    - vm-resize-pull-request-vars.yaml

  tasks:
    # Include shared setup tasks
    - name: Include shared setup tasks
      ansible.builtin.include_tasks: tasks/shared-setup-tasks.yaml
      tags: [always, clone, git_config, branch]

    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - instance_name_to_resize is defined
          - instance_name_to_resize | length > 0
          - new_instance_type is defined
          - new_instance_type | length > 0
        fail_msg: "instance_name_to_resize and new_instance_type must be defined and not empty"
      tags: [always]

    - name: Update VM instance type in instances.tf
      ansible.builtin.replace:
        path: "{{ clone_dest }}/{{ file_to_modify }}"
        regexp: '(# BEGIN ANSIBLE MANAGED BLOCK - {{ instance_name_to_resize }}[\s\S]*?instance_type\s*=\s*")[^"]+("[\s\S]*?# END ANSIBLE MANAGED BLOCK - {{ instance_name_to_resize }})'
        replace: '\g<1>{{ new_instance_type }}\g<2>'
      register: instance_type_change
      failed_when: instance_type_change is not changed
      tags: [modify_file]

    # Include shared Git workflow tasks (commit, push, PR creation, cleanup)
    - name: Include shared Git workflow tasks
      ansible.builtin.include_tasks: tasks/shared-git-tasks.yaml
      vars:
        changes_made: "{{ instance_type_change.changed }}"
      tags: [commit, push, pull_request, cleanup]

    - name: Set stats for workflow - Pass variables to Part 2
      ansible.builtin.set_stats:
        data:
          pr_creation: "{{ pr_creation }}"
          req_id: "{{ req_id }}"
          instance_name_to_resize: "{{ instance_name_to_resize }}"
          new_instance_type: "{{ new_instance_type }}"
        per_host: false
        aggregate: false
      when: pr_creation is defined and instance_type_change.changed
      tags: [workflow_stats]
