resource "aws_instance" "{{ final_instance_name }}_vm" {
  provider = aws.{{ aws_region | replace('-', '_') }}

  ami           = "{{ ami_info.ami_id }}"
  instance_type = "{{ vm_size | default('t3.medium') }}"
  key_name      = module.{{ aws_region | replace('-', '_') }}[0].key_pair_name
  subnet_id     = module.{{ aws_region | replace('-', '_') }}[0].subnet_id

{% if ami_info.osType == 'Windows' %}
  vpc_security_group_ids = [module.{{ aws_region | replace('-', '_') }}[0].windows_winrm_security_group_id]

  # Enable detailed monitoring for Windows instances
  monitoring = true

  # User data script to configure WinRM with certificate authentication
  user_data = base64encode(templatefile("${path.module}/windows-winrm-basic.ps1", {
    certificate_content = file("${path.module}/aap-client-certificate.crt")
  }))
{% else %}
  vpc_security_group_ids = [module.{{ aws_region | replace('-', '_') }}[0].security_group_id]
{% endif %}

  tags = {
    Name        = "{{ final_instance_name | replace('_', '-') }}-VM-{{ aws_region }}"
    Environment = "Development"
    CreatedBy   = "AAP"
    Region      = "{{ aws_region }}"
    OsType      = "{{ ami_info.osType }}"
    RequestID   = "{{ req_id }}"
  }
}
